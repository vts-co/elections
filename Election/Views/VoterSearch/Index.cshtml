@{
    ViewBag.Title = "بحث الناخبين";
    Layout = "~/Views/Shared/_Layout.cshtml";
}



<div class="card">
    <div class="card-header">

        <div class="row">
            <h2 class="col"> @ViewBag.Title </h2>
            <p class="col-auto">
            </p>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label>المركز</label>
                <select id="center" class="form-control">
                    <option value="">-- كل المراكز --</option>
                    @foreach (var c in ViewBag.Centers as List<string>)
                    {
                        <option value="@c">@c</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label>القرية</label>
                <select id="village" class="form-control">
                    <option value="">-- كل القرى --</option>
                </select>
            </div>
            <div class="col-md-6" style="display:none;">
                <label>العزبة</label>
                <select id="farm" class="form-control">
                    <option value="">-- كل العزب --</option>
                </select>
            </div>

            <div class="col-md-6">
                <label>المدرسة</label>
                <select id="school" class="form-control">
                    <option value="">-- كل المدارس --</option>
                </select>
            </div>
            <div class="col-md-3">
                <label>حالة الحضور</label>
                <select id="AttendFilter" class="form-control">
                    <option value="">-- الكل  --</option>
                    <option value="1"> تم الحضور </option>
                    <option value="2"> لم يتم الحضور </option>
                </select>
            </div>
            <div class="col-md-3">
                <label>رقم اللجنة الفرعية </label>
                <input id="Subcommittee" class="form-control" placeholder="ادخل رقم اللجنة الفرعية" />
            </div>
            <div class="col-md-6">
                <label>اسم الناخب</label>
                <input id="name" class="form-control" placeholder="ادخل اسم الناخب" />
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12 d-flex justify-content-end">
                <div class="btn-group" role="group" style="gap: 10px;">
                    <button id="btnSearch" class="btn btn-primary px-4">
                        <i class="fa fa-search me-2"></i> بحث
                    </button>

                    <button id="btnExportExcel" class="btn btn-success px-4">
                        <i class="fa fa-file-excel-o me-2"></i> تصدير إلى Excel
                    </button>
                </div>
            </div>
        </div>





        <hr />

        <table id="votersTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>الرقم</th>        <!-- Serial -->
                    <th>الاسم</th>        <!-- Name -->
                    <th>المركز</th>       <!-- Center -->
                    <th>القرية</th>       <!-- Village -->
                    <th>المدرسة</th>      <!-- School -->
                    <th>اللجنة الفرعية</th><!-- Subcommittee -->
                    @*<th style="display:none">العزبة</th>*@ <!-- Farm (مخفي افتراضياً) -->
                    <th>الحضور</th>       <!-- IsAttent -->
                    <th>الإجراءات</th>    <!-- Buttons -->
                </tr>
            </thead>
            <tbody></tbody>
        </table>

    </div>
</div>

<!-- Modal: تفاصيل الناخب -->
<!-- Modal: تفاصيل الناخب -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title text-light">تفاصيل الناخب</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="modalContent">
                <i class="fa fa-spinner fa-spin fa-2x text-primary"></i> جاري التحميل...
            </div>

            <div class="modal-footer">
                <button id="btnMarkAttend" class="btn btn-success">
                    <i class="fa fa-check"></i> تسجيل الحضور
                </button>
                <button id="btnPrintVoter" class="btn btn-primary">
                    <i class="fa fa-print"></i> طباعة بيانات الناخب
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>

        </div>
    </div>
</div>


@section scripts{
    <script>
$(document).ready(function () {

    let showFarmColumn = false;

    // 🟢 إنشاء جدول DataTable

var table = $('#votersTable').DataTable({
    serverSide: true,
    processing: true,
    ordering: false,
    autoWidth: false,      // يمنع العرض التلقائي
    deferLoading: 0,
    ajax: {
        url: '@Url.Action("GetVoters", "VoterSearch")',
        type: 'POST',
        data: function (d) {
            d.center = $('#center').val();
            d.village = $('#village').val();
            d.school = $('#school').val();
            d.farm = $('#farm').val();
            d.name = $('#name').val();
            d.Subcommittee = $('#Subcommittee').val();
            d.AttendFilter = $('#AttendFilter').val();
        }
    },
    lengthMenu: [10, 25, 50, 100],
    columns: [
        { data: 'Serial' },
        { data: 'Name' },
        { data: 'Center' },
        { data: 'Village' },
        {
            // هنا التغيير الأساسي 👇
            data: null,
            render: function (data, type, row) {
                if (showFarmColumn) {
                    return row.Farm || '-';
                } else {
                    return row.School || '-';
                }
            }
        },
        { data: 'Subcommittee' },
        {
            data: 'IsAttent',
            render: function(data) {
                return data ? '<span class="badge bg-success">تم الحضور</span>'
                            : '<span class="badge bg-secondary">لم يحضر</span>';
            }
        },
        {
            data: null,
            orderable: false,
            searchable: false,
            render: function (data, type, row) {
                var detailsBtn = `<button class="btn btn-sm btn-info btn-details" data-id="${row.Id}">
                                      <i class="fa fa-eye"></i> تفاصيل
                                  </button>`;
                var attendBtn = !row.IsAttent
                    ? `<button class="btn btn-sm btn-success btn-attend" data-id="${row.Id}">
                           <i class="fa fa-check"></i> حضور
                       </button>` : '';
                return `<div class="btn-group" role="group">${detailsBtn}${attendBtn}</div>`;
            }
        }
    ],
    dom: 'Bfrtip',
    buttons: [
        { extend: 'copy', text: '<i class="fa fa-file p-1"></i>نسخ', className: 'btn btn-default' },
        { extend: 'excel', text: '<i class="fa fa-list-alt p-1"></i>نسخة اكسيل', className: 'btn btn-default' },
        {
            extend: 'print',
            text: '<i class="fa fa-print p-1"></i>طباعة',
            title: '@ViewBag.Title',
            className: 'btn btn-default',
            exportOptions: {
                columns: ':visible:not(:eq(7))' // استبعاد عمود الإجراءات فقط
            },
            customize: function (win) {
                $(win.document.body).find('th').css('text-align', 'center');
                $(win.document.body).find('table').css({
                    'font-size': '16px',
                    'text-align': 'center'
                });
                $(win.document.body).css('direction', 'rtl');
            }
        }
    ],
    language: {
        search: "بحث:",
        lengthMenu: "عرض _MENU_ عنصر لكل صفحة",
        info: "العناصر من _START_ إلى _END_ من أصل _TOTAL_ عنصر",
        processing: "جارٍ التحميل...",
        zeroRecords: "لا يوجد سجلات لعرضها",
        infoFiltered: "",
        infoEmpty: '',
        paginate: { first: "الأول", last: "الأخير", next: 'التالي', previous: 'السابق' }
    }
});
    // 🔍 زر البحث
    $('#btnSearch').on('click', function () {
        table.ajax.reload();
    });

    // 🧹 زر المسح
    $('#btnClear').on('click', function () {
        $('#center, #village, #school, #farm, #name, #Subcommittee').val('');
        table.clear().draw();
    });

    // 🌳 تحديث القوائم عند اختيار المركز
    $('#center').change(function () {
        var center = $(this).val();
        $('#village').empty().append('<option value="">-- كل القرى --</option>');
        $('#school').empty().append('<option value="">-- كل المدارس --</option>');
        $('#farm').empty().append('<option value="">-- كل العزب --</option>');
        $('#farm').closest('.col-md-6').hide();
        if (center) {
            $.getJSON('@Url.Action("GetVillages", "VoterSearch")', { center: center }, function (data) {
                $.each(data, function (i, village) {
                    $('#village').append($('<option>', { value: village, text: village }));
                });
            });
        }
    });

    // ✅ إظهار عمود العزبة فقط عند القرية المطلوبة
    $('#village').change(function () {
    var village = $(this).val();
    $('#school').empty().append('<option value="">-- كل المدارس --</option>');
    $('#farm').empty().append('<option value="">-- كل العزب --</option>');
    var villageText = $(this).find('option:selected').text();

    // لو فيها عزبة أو عزب
    if (villageText.includes("عزبة") || villageText.includes("عزب")) {
        showFarmColumn = true;
        $(table.column(4).header()).text('العزبة');
    } else {
        showFarmColumn = false;
        $(table.column(4).header()).text('المدرسة');
    }
        if (village === "محمد عبدالجليل العزيزية(عزب)" || village === "محمد عبدالجليل العزيزية)عزب(") {
            $('#farm').closest('.col-md-6').show();
        } else {
            $('#farm').closest('.col-md-6').hide();
        }
    // تحميل المدارس والعزب
    if (village) {
        $.getJSON('@Url.Action("GetSchools", "VoterSearch")', { village: village }, function (data) {
            $.each(data, function (i, school) {
                $('#school').append($('<option>', { value: school, text: school }));
            });
        });

        $.getJSON('@Url.Action("GetfarmSchools", "VoterSearch")', { village: village }, function (data) {
            $.each(data, function (i, farm) {
                $('#farm').append($('<option>', { value: farm, text: farm }));
            });
        });
    }

    // إعادة تحميل الجدول بعد التغيير
    //table.ajax.reload();
});

    // ✅ زر تسجيل الحضور داخل الجدول
    $('#votersTable').on('click', '.btn-attend', function () {
        var voterId = $(this).data('id');
        Swal.fire({
            title: 'تأكيد الحضور',
            text: "هل تريد تسجيل حضور هذا الناخب؟",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#d33',
            confirmButtonText: 'نعم، تسجيل',
            cancelButtonText: 'إلغاء'
        }).then((result) => {
            if (result.isConfirmed) {
                $.post('@Url.Action("MarkAsAttended", "VoterSearch")', { id: voterId })
                    .done(function (response) {
                        if (response.success) {
                            Swal.fire({ icon: 'success', title: 'تم', text: 'تم تسجيل حضور الناخب بنجاح', timer: 1500, showConfirmButton: false });
                            table.ajax.reload(null, false);
                        } else {
                            Swal.fire('خطأ', response.message || 'حدث خطأ أثناء التسجيل', 'error');
                        }
                    })
                    .fail(function () { Swal.fire('خطأ', 'لم يتم الاتصال بالخادم', 'error'); });
            }
        });
    });
    // 👁️ زر التفاصيل - تفويض الحدث (delegation) للعمل مع صفوف DataTable الديناميكية
$('#votersTable').on('click', '.btn-details', function (e) {
    e.preventDefault();

    var $btn = $(this);
    var voterId = $btn.data('id');

    // فحص وجود id
    if (!voterId) {
        console.warn('btn-details clicked but data-id missing:', $btn);
        return Swal.fire({ icon: 'warning', title: 'تحذير', text: 'لم يتم العثور على رقم الناخب.' });
    }

    // إظهار المودال ووضع سبينر
    $('#detailsModal').data('voter-id', voterId);
    $('#detailsModal').modal('show');
    $('#modalContent').html('<div class="text-center p-4"><i class="fa fa-spinner fa-spin fa-2x"></i><div>جاري التحميل...</div></div>');

    // طلب تفاصيل الناخب من السيرفر
    $.get('@Url.Action("GetVoterDetails", "VoterSearch")', { id: voterId })
        .done(function (html) {
            // أدخل الـ HTML المعاد في المودال
            $('#modalContent').html(html);

            // بعد التحميل: فعل/أوقف زر "تسجيل الحضور" داخل المودال اعتماداً على الحالة
            var isAttentAttr = $('#modalContent').find('[data-voter-attent]').data('voter-attent');
            var isAttent = (isAttentAttr === true || String(isAttentAttr).toLowerCase() === 'true');

            if (isAttent) {
                $('#btnMarkAttend').hide();
            } else {
                $('#btnMarkAttend').show()
                    .removeClass('btn-secondary').addClass('btn-success')
                    .prop('disabled', false)
                    .html('<i class="fa fa-check"></i> تسجيل الحضور');
            }
        })
        .fail(function (xhr, status, err) {
            console.error('GetVoterDetails failed:', status, err);
            $('#modalContent').html('<div class="text-danger p-3">حدث خطأ أثناء تحميل البيانات. حاول مرة أخرى.</div>');
        });
});
    $('#btnMarkAttend').on('click', function () {
    var voterId = $('#detailsModal').data('voter-id'); // ناخد ID من المودال نفسه

    if (!voterId) {
        return Swal.fire({ icon: 'warning', title: 'تحذير', text: 'لم يتم العثور على رقم الناخب.' });
    }

    Swal.fire({
        title: 'تأكيد الحضور',
        text: "هل تريد تسجيل حضور هذا الناخب؟",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#d33',
        confirmButtonText: 'نعم، تسجيل',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            $.post('@Url.Action("MarkAsAttended", "VoterSearch")', { id: voterId })
                .done(function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'تم',
                            text: 'تم تسجيل حضور الناخب بنجاح',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        $('#detailsModal').modal('hide'); // إغلاق المودال
                        table.ajax.reload(null, false);    // تحديث الجدول بدون إعادة التحميل الكامل
                    } else {
                        Swal.fire('خطأ', response.message || 'حدث خطأ أثناء التسجيل', 'error');
                    }
                })
                .fail(function () {
                    Swal.fire('خطأ', 'لم يتم الاتصال بالخادم', 'error');
                });
        }
    });
    });
    // 🖨️ طباعة بيانات الناخب من المودال
    var logoUrl = '@Url.Content("~/assets/images/LogoElection.png")';
    $('#btnPrintVoter').on('click', function () {
        var modal = document.getElementById('modalContent').cloneNode(true);
        modal.querySelectorAll('.no-print').forEach(el => el.remove());

        var printContents = modal.innerHTML;
        var printWindow = window.open('', '', 'width=400,height=600');
        var now = new Date();
        var formattedDate = now.toLocaleString('ar-EG');

        printWindow.document.write(`
        <html dir="rtl" lang="ar">
        <head>
            <title>طباعة بيانات الناخب</title>
            <style>
                body { font-family: 'Tahoma', sans-serif; text-align: center; direction: rtl; width: 80mm; margin: 0 auto; }
                .logo { text-align: center; margin-bottom: 10px; }
                .logo img { width: 70px; height: 70px; border-radius: 50%; }
                h2 { margin: 5px 0; }
                table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top:
                10px; }
                td, th { padding: 6px; border: 1px dashed #999; }
                .footer { margin-top: 20px; font-size: 13px; border-top: 1px solid #ddd; padding-top: 10px; }
            </style>
        </head>
        <body>
            <div class="logo">
                <img src="${logoUrl}" alt="شعار المرشح" />
            </div>
            <h2>بطاقة بيانات الناخب</h2>
            ${printContents}
            <div class="footer">
                <div>${formattedDate}</div>
            </div>
        </body>
        </html>
        `);

        printWindow.document.close();
        printWindow.onload = function () {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        };
    });

    // داخل $(document).ready(...)
$('#btnExportExcel').on('click', function () {
    var url = '@Url.Action("ExportToExcel", "VoterSearch")' +
        '?center=' + encodeURIComponent($('#center').val() || '') +
        '&village=' + encodeURIComponent($('#village').val() || '') +
        '&school=' + encodeURIComponent($('#school').val() || '') +
        '&farm=' + encodeURIComponent($('#farm').val() || '') +
        '&attendFilter=' + encodeURIComponent($('#AttendFilter').val() || '') +
        '&subcommittee=' + encodeURIComponent($('#Subcommittee').val() || '') +
        '&name=' + encodeURIComponent($('#name').val() || '');

    // افتح الرابط لتنزيل الملف
    window.location.href = url;
});

});
        // ✅ زر تسجيل الحضور داخل المودال (Popup)


    </script>


}
