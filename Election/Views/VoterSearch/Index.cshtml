@{
    ViewBag.Title = "بحث الناخبين";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="">

    <div class="row">
        <div class="col-md-3">
            <label>المركز</label>
            <select id="center" class="form-control">
                <option value="">-- كل المراكز --</option>
                @foreach (var c in ViewBag.Centers as List<string>)
                {
                    <option value="@c">@c</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label>القرية</label>
            <select id="village" class="form-control">
                <option value="">-- كل القرى --</option>
            </select>
        </div>

        <div class="col-md-6">
            <label>المدرسة</label>
            <select id="school" class="form-control">
                <option value="">-- كل المدارس --</option>
            </select>
        </div>
        <div class="col-md-3">
            <label>رقم اللجنة الفرعية </label>
            <input id="Subcommittee" class="form-control" placeholder="ادخل رقم اللجنة الفرعية" />
        </div>
        <div class="col-md-9">
            <label>اسم الناخب</label>
            <input id="name" class="form-control" placeholder="ادخل اسم الناخب" />
        </div>
    </div>
    <div class="row" style="margin-top:10px;">
        <div class="col-md-12">
            <button id="btnSearch" class="btn btn-primary w-25" style="float:left;">
                <i class="fa fa-search me-2"></i> بحث
            </button>
        </div>
    </div>



    <hr />

    <table id="votersTable" class="table table-striped dt-responsive  nowrap w-100 " style="width:100%">
        <thead>
            <tr>
                <th>المسلسل </th>

                <th>الاسم</th>
                <th>المركز</th>
                <th>القرية</th>
                <th>المدرسة</th>
                <th>اللجنة الفرعية</th>
                <th>الحضور</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
<!-- Modal: تفاصيل الناخب -->
<!-- Modal: تفاصيل الناخب -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title text-light">تفاصيل الناخب</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="modalContent">
                <i class="fa fa-spinner fa-spin fa-2x text-primary"></i> جاري التحميل...
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                <button id="btnPrintVoter" class="btn btn-success">
                    <i class="fa fa-print"></i> طباعة
                </button>
            </div>
        </div>
    </div>
</div>



@section scripts{

    <script>
$(document).ready(function () {

    // 🟢 إنشاء جدول DataTable
    var table = $('#votersTable').DataTable({
        serverSide: true,
        processing: true,
        ordering: false,
        // يمنع تحميل البيانات أول مرة
        deferLoading: 0,
        ajax: {
            url: '@Url.Action("GetVoters", "VoterSearch")',
            type: 'POST',
            data: function (d) {
                d.center = $('#center').val();
                d.village = $('#village').val();
                d.school = $('#school').val();
                d.name = $('#name').val();
                d.Subcommittee = $('#Subcommittee').val();
            }
        },
        lengthMenu: [10, 25, 50, 100],
        columns: [
            { data: 'Serial' },
            { data: 'Name' },
            { data: 'Center' },
            { data: 'Village' },
            { data: 'School' },
            { data: 'Subcommittee' },
            { data: 'Attent' },
            {
                data: null,
                orderable: false,
                searchable: false,
                render: function (data, type, row) {
                    return `
                        <button class="btn btn-sm btn-info btn-details" data-id="${row.Id}">
                            <i class="fa fa-eye"></i> تفاصيل
                        </button>
                    `;
                }
            }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                text: '<i class="fa fa-file p-1"></i>نسخ',
                className: 'btn btn-default'
            },
            {
                extend: 'excel',
                text: '<i class="fa fa-list-alt p-1"></i>نسخة اكسيل',
                className: 'btn btn-default'
            },
            {
                extend: 'print',
                text: '<i class="fa fa-print p-1"></i>طباعة',
                title: '@ViewBag.Title',
                className: 'btn btn-default',
                customize: function (win) {
                    $(win.document.body).find('th').css('text-align', 'center');
                    $(win.document.body).find('table').css({
                        'font-size': '16px',
                        'text-align': 'center'
                    });
                    $(win.document.body).css('direction', 'rtl');
                }
            }
        ],
        language: {
            search: "بحث:",
            lengthMenu: "عرض _MENU_ عنصر لكل صفحة",
            info: "العناصر من _START_ إلى _END_ من أصل _TOTAL_ عنصر",
            processing: "جارٍ التحميل...",
            zeroRecords: "لا يوجد سجلات لعرضها",
            infoFiltered: "",
            infoEmpty: '',
            paginate: {
                first: "الأول",
                last: "الأخير",
                next: 'التالي',
                previous: 'السابق'
            }
        }
    });

    // 🔍 زر البحث
    $('#btnSearch').on('click', function () {
        table.ajax.reload();
    });

    // 🧹 زر المسح
    $('#btnClear').on('click', function () {
        $('#center, #village, #school, #name, #Subcommittee').val('');
        table.clear().draw(); // يمسح النتائج الحالية
    });

    // 👁️ زر التفاصيل داخل الجدول
    $('#votersTable').on('click', '.btn-details', function () {
        var voterId = $(this).data('id');

        // إظهار المودال
        $('#detailsModal').modal('show');

        // إظهار مؤشر تحميل مؤقت
        $('#modalContent').html('<i class="fa fa-spinner fa-spin fa-2x text-primary"></i> جاري التحميل...');

        // جلب البيانات من السيرفر
        $.get('@Url.Action("GetVoterDetails", "VoterSearch")', { id: voterId })
            .done(function (data) {
                $('#modalContent').html(data);
            })
            .fail(function () {
                $('#modalContent').html('<div class="alert alert-danger">حدث خطأ أثناء تحميل البيانات</div>');
            });
    });

});
    </script>

    <script>
    $(document).ready(function () {

        // عند اختيار المركز
        $('#center').change(function () {
            var center = $(this).val();
            $('#village').empty().append('<option value="">-- كل القرى --</option>');
            $('#school').empty().append('<option value="">-- كل المدارس --</option>');

            if (center) {
                $.getJSON('@Url.Action("GetVillages", "VoterSearch")', { center: center }, function (data) {
                    $.each(data, function (i, village) {
                        $('#village').append($('<option>', {
                            value: village,
                            text: village
                        }));
                    });
                });
            }
        });

        // عند اختيار القرية
        $('#village').change(function () {
            var village = $(this).val();
            $('#school').empty().append('<option value="">-- كل المدارس --</option>');

            if (village) {
                $.getJSON('@Url.Action("GetSchools", "VoterSearch")', { village: village }, function (data) {
                    $.each(data, function (i, school) {
                        $('#school').append($('<option>', {
                            value: school,
                            text: school
                        }));
                    });
                });
            }
        });

    });
    </script>
    <script>
        // 🖨️ زر الطباعة داخل المودال
        $('#btnPrintVoter').on('click', function () {
            var printContents = document.getElementById('modalContent').innerHTML;

            // إنشاء نافذة الطباعة
            var printWindow = window.open('', '', 'width=400,height=600');
            var now = new Date();
            var formattedDate = now.toLocaleString('ar-EG');

            printWindow.document.write(`
        <html dir="rtl" lang="ar">
        <head>
            <style>
                body {
                    font-family: 'Tahoma', sans-serif;
                    text-align: center;
                    direction: rtl;
                    width: 80mm; /* عرض رول الطباعة */
                    margin: 0 auto;
                }
                .logo {
                    text-align: center;
                    margin-bottom: 10px;
                }
                .logo img {
                    width: 70px;
                    height: 70px;
                    border-radius: 50%;
                }
                h2 {
                    margin: 5px 0;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 14px;
                    margin-top: 10px;
                }
                td, th {
                    padding: 6px;
                    border: 1px dashed #999;
                }
                .footer {
                    margin-top: 20px;
                    font-size: 13px;
                    border-top: 1px solid #ddd;
                    padding-top: 10px;
                }
            </style>
        </head>
        <body>
            <div class="logo">
                <img src="@Url.Content("~/assets/images/users/avatar-1.jpg")" alt="شعار المرشح" />
            </div>
            <h2>بطاقة بيانات الناخب</h2>
            ${printContents}
            <div class="footer">
                <div> ${formattedDate}</div>
            </div>
        </body>
        </html>
    `);

            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        });

    </script>
}