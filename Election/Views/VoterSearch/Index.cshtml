@{
    ViewBag.Title = "بحث الناخبين";
    Layout = "~/Views/Shared/_Layout.cshtml";
}



<div class="card">
    <div class="card-header">

        <div class="row">
            <h2 class="col"> @ViewBag.Title </h2>
            <p class="col-auto">
            </p>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label>المركز</label>
                <select id="center" class="form-control">
                    <option value="">-- كل المراكز --</option>
                    @foreach (var c in ViewBag.Centers as List<string>)
                    {
                        <option value="@c">@c</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label>القرية</label>
                <select id="village" class="form-control">
                    <option value="">-- كل القرى --</option>
                </select>
            </div>

            <div class="col-md-6">
                <label>المدرسة</label>
                <select id="school" class="form-control">
                    <option value="">-- كل المدارس --</option>
                </select>
            </div>
            <div class="col-md-3">
                <label>حالة الحضور</label>
                <select id="AttendFilter" class="form-control">
                    <option value="">-- الكل  --</option>
                    <option value="1"> تم الحضور </option>
                    <option value="2"> لم يتم الحضور </option>
                </select>
            </div>
            <div class="col-md-3">
                <label>رقم اللجنة الفرعية </label>
                <input id="Subcommittee" class="form-control" placeholder="ادخل رقم اللجنة الفرعية" />
            </div>
            <div class="col-md-6">
                <label>اسم الناخب</label>
                <input id="name" class="form-control" placeholder="ادخل اسم الناخب" />
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12 d-flex justify-content-end">
                <div class="btn-group" role="group" style="gap: 10px;">
                    <button id="btnSearch" class="btn btn-primary px-4">
                        <i class="fa fa-search me-2"></i> بحث
                    </button>

                    <button id="btnExportExcel" class="btn btn-success px-4">
                        <i class="fa fa-file-excel-o me-2"></i> تصدير إلى Excel
                    </button>
                </div>
            </div>
        </div>





        <hr />

        <table id="votersTable" class="table table-striped dt-responsive  nowrap w-100 " style="width:100%">
            <thead>
                <tr>
                    <th>المسلسل </th>

                    <th>الاسم</th>
                    <th>المركز</th>
                    <th>القرية</th>
                    <th>المدرسة</th>
                    <th>اللجنة الفرعية</th>
                    <th>الحضور</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Modal: تفاصيل الناخب -->
<!-- Modal: تفاصيل الناخب -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title text-light">تفاصيل الناخب</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="modalContent">
                <i class="fa fa-spinner fa-spin fa-2x text-primary"></i> جاري التحميل...
            </div>
         
            <div class="modal-footer">
                <button id="btnMarkAttend" class="btn btn-success">
                    <i class="fa fa-check"></i> تسجيل الحضور
                </button>
                <button id="btnPrintVoter" class="btn btn-primary">
                    <i class="fa fa-print"></i> طباعة بيانات الناخب
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>

        </div>
    </div>
</div>



@section scripts{

    <script>
$(document).ready(function () {

    // 🟢 إنشاء جدول DataTable
    var table = $('#votersTable').DataTable({
        serverSide: true,
        processing: true,
        ordering: false,
        // يمنع تحميل البيانات أول مرة
        deferLoading: 0,
        ajax: {
            url: '@Url.Action("GetVoters", "VoterSearch")',
            type: 'POST',
            data: function (d) {
                d.center = $('#center').val();
                d.village = $('#village').val();
                d.school = $('#school').val();
                d.name = $('#name').val();
                d.Subcommittee = $('#Subcommittee').val();
                d.AttendFilter = $('#AttendFilter').val();
            }
        },
        lengthMenu: [10, 25, 50, 100],
        columns: [
            { data: 'Serial' },
            { data: 'Name' },
            { data: 'Center' },
            { data: 'Village' },
            { data: 'School' },
            { data: 'Subcommittee' },
            { data: 'Attent' },
            {
                data: null,
                orderable: false,
                searchable: false,
                render: function (data, type, row) {
                    return `
                        <button class="btn btn-sm btn-info btn-details" data-id="${row.Id}">
                            <i class="fa fa-eye"></i> تفاصيل
                        </button>
                    `;
                }
            }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                text: '<i class="fa fa-file p-1"></i>نسخ',
                className: 'btn btn-default'
            },
            {
                extend: 'excel',
                text: '<i class="fa fa-list-alt p-1"></i>نسخة اكسيل',
                className: 'btn btn-default'
            },
            {
                extend: 'print',
                text: '<i class="fa fa-print p-1"></i>طباعة',
                title: '@ViewBag.Title',
                className: 'btn btn-default',
                customize: function (win) {
                    $(win.document.body).find('th').css('text-align', 'center');
                    $(win.document.body).find('table').css({
                        'font-size': '16px',
                        'text-align': 'center'
                    });
                    $(win.document.body).css('direction', 'rtl');
                }
            }
        ],
        language: {
            search: "بحث:",
            lengthMenu: "عرض _MENU_ عنصر لكل صفحة",
            info: "العناصر من _START_ إلى _END_ من أصل _TOTAL_ عنصر",
            processing: "جارٍ التحميل...",
            zeroRecords: "لا يوجد سجلات لعرضها",
            infoFiltered: "",
            infoEmpty: '',
            paginate: {
                first: "الأول",
                last: "الأخير",
                next: 'التالي',
                previous: 'السابق'
            }
        }
    });

    // 🔍 زر البحث
    $('#btnSearch').on('click', function () {
        table.ajax.reload();
    });

    // 🧹 زر المسح
    $('#btnClear').on('click', function () {
        $('#center, #village, #school, #name, #Subcommittee').val('');
        table.clear().draw(); // يمسح النتائج الحالية
    });

    // 👁️ زر التفاصيل داخل الجدول
    $('#votersTable').on('click', '.btn-details', function () {
        var voterId = $(this).data('id');

        // إظهار المودال
        $('#detailsModal').modal('show');

        // إظهار مؤشر تحميل مؤقت
        $('#modalContent').html('<i class="fa fa-spinner fa-spin fa-2x text-primary"></i> جاري التحميل...');

        // جلب البيانات من السيرفر
        $.get('@Url.Action("GetVoterDetails", "VoterSearch")', { id: voterId })
            .done(function (data) {
                $('#modalContent').html(data);
            })
            .fail(function () {
                $('#modalContent').html('<div class="alert alert-danger">حدث خطأ أثناء تحميل البيانات</div>');
            });
    });

});
    </script>

    <script>
    $(document).ready(function () {

        // عند اختيار المركز
        $('#center').change(function () {
            var center = $(this).val();
            $('#village').empty().append('<option value="">-- كل القرى --</option>');
            $('#school').empty().append('<option value="">-- كل المدارس --</option>');

            if (center) {
                $.getJSON('@Url.Action("GetVillages", "VoterSearch")', { center: center }, function (data) {
                    $.each(data, function (i, village) {
                        $('#village').append($('<option>', {
                            value: village,
                            text: village
                        }));
                    });
                });
            }
        });

        // عند اختيار القرية
        $('#village').change(function () {
            var village = $(this).val();
            $('#school').empty().append('<option value="">-- كل المدارس --</option>');

            if (village) {
                $.getJSON('@Url.Action("GetSchools", "VoterSearch")', { village: village }, function (data) {
                    $.each(data, function (i, school) {
                        $('#school').append($('<option>', {
                            value: school,
                            text: school
                        }));
                    });
                });
            }
        });

    });
    </script>
    <script>
        $('#btnExportExcel').click(function () {
            var center = $('#center').val();
            var village = $('#village').val();
            var school = $('#school').val();
            var attendFilter = $('#AttendFilter').val();
            var subcommittee = $('#Subcommittee').val();
            var name = $('#name').val();

            // نبني رابط الاستيراد
            var url = '/VoterSearch/ExportToExcel?center=' + encodeURIComponent(center)
                + '&village=' + encodeURIComponent(village)
                + '&school=' + encodeURIComponent(school)
                + '&attendFilter=' + encodeURIComponent(attendFilter)
                + '&subcommittee=' + encodeURIComponent(subcommittee)
                + '&name=' + encodeURIComponent(name);

            window.location.href = url; // تحميل الملف مباشرة
        });

    // نخزن المسار الكامل من السيرفر
    var logoUrl = '@Url.Content("~/assets/images/LogoElection.png")';
    // 🖨️ زر الطباعة داخل المودال
        $('#btnPrintVoter').on('click', function () {
            // ننسخ محتوى المودال بدون صفوف no-print
            var modal = document.getElementById('modalContent').cloneNode(true);

            // نحذف كل العناصر اللي ما نريد طباعتها
            modal.querySelectorAll('.no-print').forEach(el => el.remove());

            var printContents = modal.innerHTML;
            var printWindow = window.open('', '', 'width=400,height=600');
            var now = new Date();
            var formattedDate = now.toLocaleString('ar-EG');

            printWindow.document.write(`
        <html dir="rtl" lang="ar">
        <head>
            <title>طباعة بيانات الناخب</title>
            <style>
                body {
                    font-family: 'Tahoma', sans-serif;
                    text-align: center;
                    direction: rtl;
                    width: 80mm; /* عرض رول الطباعة */
                    margin: 0 auto;
                }
                .logo {
                    text-align: center;
                    margin-bottom: 10px;
                }
                .logo img {
                    width: 70px;
                    height: 70px;
                    border-radius: 50%;
                }
                h2 {
                    margin: 5px 0;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 14px;
                    margin-top: 10px;
                }
                td, th {
                    padding: 6px;
                    border: 1px dashed #999;
                }
                .footer {
                    margin-top: 20px;
                    font-size: 13px;
                    border-top: 1px solid #ddd;
                    padding-top: 10px;
                }
            </style>
        </head>
        <body>
            <div class="logo">
                <img src="${logoUrl}" alt="شعار المرشح" />
            </div>
            <h2>بطاقة بيانات الناخب</h2>
            ${printContents}
            <div class="footer">
                <div>${formattedDate}</div>
            </div>
        </body>
        </html>
    `);

            printWindow.document.close();

            printWindow.onload = function () {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };
        });

        // ✅ زر تسجيل الحضور داخل المودال
// ✅ زر تسجيل الحضور داخل المودال باستخدام SweetAlert2
$('#btnMarkAttend').on('click', function () {
    var voterId = $('#modalContent').find('[data-voter-id]').data('voter-id');
    var $btn = $(this);

    if (!voterId) {
        Swal.fire({
            icon: 'warning',
            title: 'تنبيه',
            text: 'لم يتم العثور على رقم الناخب'
        });
        return;
    }

    Swal.fire({
        title: 'تأكيد تسجيل الحضور',
        text: "هل تريد تسجيل حضور هذا الناخب؟",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'نعم، تأكيد',
        cancelButtonText: 'إلغاء',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            $.post('@Url.Action("MarkAsAttended", "VoterSearch")', { id: voterId })
                .done(function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'تم التسجيل',
                            text: '✅ تم تسجيل الحضور بنجاح',
                            timer: 2000,
                            showConfirmButton: false
                        });

                        // تحديث الزر
                        $btn
                            .removeClass('btn-success')
                            .addClass('btn-secondary')
                            .prop('disabled', true)
                            .html('<i class="fa fa-check-circle"></i> تم الحضور');
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'تحذير',
                            text: response.message || 'لم يتم التسجيل'
                        });
                    }
                })
                .fail(function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ',
                        text: 'حدث خطأ أثناء تسجيل الحضور'
                    });
                });
        }
    });
});


    </script>
}