@{
    ViewBag.Title = "إحصائيات الناخبين";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="card">
    <div class="card-header">

        <div class="row">
            <h2 class="col"> @ViewBag.Title </h2>
            <p class="col-auto">
            </p>
        </div>
    </div>
    <div class="card-body">

        <!-- 🔍 الفلاتر -->
        <div class="row mb-4 align-items-end" dir="rtl">
            <div class="col-md-3">
                <label>المركز</label>
                <select id="ddlCenter" class="form-control">
                    <option value="">الكل</option>
                    @foreach (var c in ViewBag.Centers)
                    {
                        <option value="@c">@c</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label>القرية</label>
                <select id="ddlVillage" class="form-control">
                    <option value="">الكل</option>
                    @foreach (var v in ViewBag.Villages)
                    {
                        <option value="@v">@v</option>
                    }
                </select>
            </div>

            <div class="col-md-5">
                <label>المدرسة</label>
                <select id="ddlSchool" class="form-control">
                    <option value="">الكل</option>
                    @foreach (var s in ViewBag.Schools)
                    {
                        <option value="@s">@s</option>
                    }
                </select>
            </div>

            <div class="col-md-1 text-center">
                <button id="btnFilter" class="btn btn-primary w-100" style="margin-top: 5px;">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>

        <!-- 🧮 الإحصائيات -->
        <div class="row text-center mb-4">
            <div class="col-md-3">
                <div class="card shadow-sm p-3 border-success">
                    <h5>✅ عدد الحضور</h5>
                    <h3 id="lblPresentCount" class="text-success">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm p-3 border-danger">
                    <h5>❌ عدد الغياب</h5>
                    <h3 id="lblAbsentCount" class="text-danger">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm p-3 border-primary">
                    <h5>📈 نسبة الحضور</h5>
                    <h3 id="lblAttendanceRate" class="text-primary">0%</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm p-3 border-secondary">
                    <h5>📉 نسبة الغياب</h5>
                    <h3 id="lblAbsentRate" class="text-secondary">0%</h3>
                </div>
            </div>

        </div>

        <!-- 📊 الرسم البياني -->
        <div class="chart-container mx-auto" style="width: 300px; height: 300px;">
            <canvas id="statsChart"></canvas>
        </div>
    </div>
</div>



@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var chart;

        $('#btnFilter').click(function () {
            var center = $('#ddlCenter').val();
            var village = $('#ddlVillage').val();
            var school = $('#ddlSchool').val();


            $.getJSON('/RptStatistics/GetStatistics', { center, village, school }, function (data) {

                $('#lblPresentCount').text(data.present);
                $('#lblAbsentCount').text(data.absent);
                $('#lblAttendanceRate').text(data.attendanceRate + '%');
                $('#lblAbsenceRate').text(data.absenceRate + '%');

                var ctx = document.getElementById('statsChart').getContext('2d');

                if (chart) chart.destroy();

                chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['حضر', 'غاب'],
                        datasets: [{
                            data: [data.present, data.absent],
                            backgroundColor: ['#28a745', '#dc3545'],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { size: 14 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.label + ': ' + context.raw + ' شخص';
                                    }
                                }
                            }
                        }
                    }
                });
            });
        });
    </script>
    <script>
    $(document).ready(function () {

        // عند اختيار المركز
        $('#ddlCenter').change(function () {
            var center = $(this).val();
            $('#ddlVillage').empty().append('<option value="">-- كل القرى --</option>');
            $('#ddlSchool').empty().append('<option value="">-- كل المدارس --</option>');

            if (center) {
                $.getJSON('@Url.Action("GetVillages", "VoterSearch")', { center: center }, function (data) {
                    $.each(data, function (i, village) {
                        $('#ddlVillage').append($('<option>', {
                            value: village,
                            text: village
                        }));
                    });
                });
            }
        });

        // عند اختيار القرية
        $('#ddlVillage').change(function () {
            var village = $(this).val();
            $('#ddlSchool').empty().append('<option value="">-- كل المدارس --</option>');

            if (village) {
                $.getJSON('@Url.Action("GetSchools", "VoterSearch")', { village: village }, function (data) {
                    $.each(data, function (i, school) {
                        $('#ddlSchool').append($('<option>', {
                            value: school,
                            text: school
                        }));
                    });
                });
            }
        });

    });
    </script>
}